<style>
    *{
        margin: 0px;
        padding: 0px;
    }
    .box{
        width: 350px;
        heigh:40px;
        align:left;
        text-align: center;
        line-height: 40px;
        border-radius: 5px;
        margin: 5px auto;
        background: orange;
        box-shadow: 2px 3px 0 #666666;
        position: relative;

    }
    .box:after{
        content: "\200B";
        display: block;
        width: 0;
        height: 0;
        border: 10px solid transparent;
        border-right: 10px solid orange;
        position: absolute;
        left: -20px;
        top: 7px;
    }
    .box1{
        width: 350px;
        height: 40px;
        line-height: 40px;
        background: dodgerblue;
        margin: 5px auto;
        border-radius: 5px;
        text-align: center;
        box-shadow: 2px 3px 0 #666666;
        position: relative;
    }
    .box1:after{
        content: "\200B";
        display: block;
        width: 0;
        height: 0;
        border: 10px solid transparent;
        border-left: 10px solid dodgerblue;
        position: absolute;
        right: -20px;
        top: 7px;
    }
</style>
<div class="layui-fluid layui-anim febs-anim" id="febs-dept" lay-title="智能问答">

    <div class="layui-card" >
        <form class="layui-form layui-table-form" lay-filter="user-table-form">
            <span id="hintMessage" class="febs-alert-base febs-alert-warn">提示：输入问题进行回答</span>
            <div class="layui-row">
                <div class="layui-col-md10">
                    <div class="layui-form-item" align="center">
                        <div class="layui-inline" style="margin-top: 10px;">
                            <label class="layui-form-label layui-form-label-sm">问题查询</label>
                            <div class="layui-input-inline" style="width: 700px">
                                <input type="text" name="policyName" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                        <submit class="layui-btn layui-btn-normal" id="query">搜索</submit>
                        <submit class="layui-btn layui-btn-normal" id="reset">重置</submit>
                    </div>
                </div>
            </div>
        </form>
        <!--<label class="layui-form-label layui-form-label-sm">政策名</label>-->
        <!--<div class="layui-input-inline">-->
        <!--<input type="text" name="policyName" autocomplete="off" class="layui-input">-->
        <!--</div>-->
        <!--<div class="layui-card-body" style="text-align:center">-->
        <!--<button class="layui-btn layui-btn-normal" id="submit" lay-demo="getChecked">政策详情</button>-->
        <!--</div>-->
    </div>
    <div class="layui-row layui-col-space8 febs-container">
        <div class="layui-col-md4 layui-col-sm4 layui-col-xs5">
            <div class="layui-card">
                <div class="layui-card-body febs-table-full" style="height:600px">

                    <form class="layui-form layui-table-form" lay-filter="dept-table-form" id="dept-table-form">
                        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
                            <legend>问答记录</legend>
                        </fieldset>
                        <div class="layui-card">
                            <table name="question-answer" id="question-answer" style="width: 376px;height: 500px"></table>

                        </div>
                        <div class="layui-row">
                            <div class="layui-col-md8 layui-col-sm8 layui-col-xs9">

                            </div>

                        </div>
                    </form>

                </div>
            </div>
        </div>
        <div class="layui-col-md8 layui-col-sm8 layui-col-xs12">
            <div class="layui-card" style="height: 630px">
                <table id="policyTablelist" name="policylist" lay-filter="policyTable" lay-data="{id: 'policyTable'}"></table>
                <table class="layui-table" id="content1">
                </table>
                <div class="layui-card-body febs-table-full my-text-class">
                    <table id="corporateTechnologyActivities-table">
                    </table>
                </div>
                <div class="layui-card-body febs-table-full">
                    <div id="container" ></div>
                </div>


                <!--<div class="layui-card-body">-->
                <!--<div id="basicColumnChart"></div>-->
                <!--</div>-->
            </div>
        </div>
        <div class="layui-col-md6 layui-col-sm6 layui-col-xs12 febs-hide" style="width:900px">
            <div class="layui-card">


                <div class="layui-card-body febs-table-full">
                    <form class="layui-form layui-table-form" action="" lay-filter="dept-form">
                        <div class="layui-form-item febs-hide">
                            <label class="layui-form-label">ID：</label>
                            <div class="layui-input-block">
                                <input type="text" name="kindId" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item febs-hide">
                            <label class="layui-form-label">branchID：</label>
                            <div class="layui-input-block">
                                <input type="text" name="branchId" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item febs-hide">
                            <label class="layui-form-label">上级ID：</label>
                            <div class="layui-input-block">
                                <input type="text" value="" id="policyid" name="Id" readonly autocomplete="off"
                                       class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item febs-hide">
                            <label class="layui-form-label"></label>
                            <div class="layui-input-block">
                                <input type="text" name="policyId" autocomplete="off" class="layui-input"
                                       lay-verify="number">
                            </div>
                        </div>
                        <button class="layui-btn febs-hide" lay-submit="" lay-filter="dept-form-submit"
                                id="submit-form"></button>


                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/html" id="user-option">
    <span shiro:lacksPermission="user:view,user:update,user:delete">
        <span class="layui-badge-dot febs-bg-orange"></span> 无权限
    </span>
    <a lay-event="detail" shiro:hasPermission="user:view"><i
            class="layui-icon febs-edit-area febs-green">&#xe7a5;</i></a>
</script>
<script type="text/html" id="user-option1">
    <a lay-event="detail1" shiro:hasPermission="user:view"><i
            class="layui-icon febs-edit-area febs-green">&#xe7a5;</i></a>
</script>
<script data-th-inline="javascript" type="text/javascript">
    layui.use([ 'dropdown', 'jquery','tree', 'validate', 'layer','febs', 'form', 'eleTree','element','table','apexcharts', 'jquery', 'util', 'echarts4', 'dataTool', 'echarts_gl'], function () {
        var $ = layui.jquery,
            febs = layui.febs,
            element = layui.element,
            tree = layui.tree,
            layer=layui.layer,
            form = layui.form,
            table=layui.table,
            $viewa = $('#febs-index'),
            echarts = layui.echarts4,
            eleTree = layui.eleTree,
            util = layui.util,
            dropdown = layui.dropdown,

            validate = layui.validate,
            $view = $('#febs-dept'),
            $query = $view.find('#query'),
            $_corporateTechnologyActivitiesTable = $view.find('#corporateTechnologyActivities-table'),
            $conint= $view.find('#container'),
            $reset = $view.find('#reset'),
            //$submit = $view.find('#submit'),
            $policyid=$view.find('#policyid'),
            $header = $view.find('#form-header'),
            $searchForm = $view.find('#dept-table-form'),
            $searchForma = $view.find('form'),
            _currentDeptData,
            _deptTree;

        form.verify(validate);
        form.render();

        var dom = document.getElementById("container");
        var myChart = echarts.init(dom);

        // febs.get(ctx + 'jsondata/getSimilarityData/' + 131, null, function (json) {
        //     initCorporateTechnologyActivities1(json);
        // });
        // febs.get(ctx + 'jsondata/getSRelationData/' + 131, null, function (json) {
        //     tu(json.data);
        // });
        // Tree_init();
        function tu(json)
        {
            var size = 20; //节点大小
            var data=json;
            var color1 = '#006acc';
            var color2 = '#ff7d18';
            var color3 = '#10a050';
            data.nodes.forEach(function(node) {
                if (node.category === 0) {
                    node.symbolSize = 50;
                    node.itemStyle = {
                        color: color1
                    };
                } else if (node.category === 1) {
                    node.itemStyle = {
                        color: color2
                    };
                }
            });

            data.links.forEach(function(link) {
                link.label = {
                    align: 'center',
                    fontSize: 10
                };

                if (link.name === '相似政策') {
                    link.lineStyle = {
                        color: color2
                    }
                }
            });

            var categories = [{
                name: '本政策',
                itemStyle: {
                    color: color1
                }
            },
                {
                    name: '相似政策',
                    itemStyle: {
                        color: color2
                    }
                }];


            var option = {
                title: {
                    text: '政策上下位关系图'
                },
                legend: [{
                    data: ["本政策","相似政策"]
                }],
                series: [{
                    type: 'graph',
                    layout: 'force',
                    symbolSize: 50,
                    draggable: true,
                    roam: true,
                    focusNodeAdjacency: true,
                    categories: categories,
                    edgeSymbol: ['', 'arrow'],
                    // edgeSymbolSize: [80, 10],
                    edgeLabel: {
                        normal: {
                            show: true,
                            textStyle: {
                                fontSize: 10
                            },
                            formatter: function (x) {
                                return x.data.name;
                            }

                        }
                    },
                    label: {
                        show: true
                    },
                    force: {
                        repulsion: 2000,
                        edgeLength: 120
                    },
                    data: data.nodes,
                    links: data.links
                }]
            };
            myChart.hideLoading();
            myChart.setOption(option);
        }
        function Tree_init()
        {
            layer.load(1);
            febs.get(ctx + 'jsondata/getTreeDataSimilarity' , null, function (json) {;
                shu(json);
                layer.closeAll('loading');
            });
        }
        policydetail= function (obj)
        {
            var policyid=$(obj).attr("policyid");
            febs.modal.view('政策信息', 'policy/detailnew/' + policyid, {
                area: $(window).width() <= 850 ? '95%' : '80%'
            });

        }
        function initCorporateTechnologyActivities1(json) {
            $_corporateTechnologyActivitiesTable.empty();
            var appendHtml = '';
            var rows = json.data.years.length + 1;
            var cols = json.data.names.length + 1;
            var tableData = new Array(rows);
            tableData[0] = json.data.names.slice();
            tableData[0].unshift('政策类型');
            for (var i = 0; i < rows; i++) {
                if (i > 0) {
                    tableData[i] = new Array(cols);
                    tableData[i][0] = json.data.years[rows - i - 1];
                    // window.alert(json.data.length);
                    for (var j = 0; j < json.data.data.length; j++) {
                        tableData[i][j + 1] = json.data.data[j].values[rows - i - 1];
                    }
                }

            }
            for (var i = 0; i < tableData.length; i++) {
                appendHtml += '<tr>';
                for (var j = 0; j < tableData[i].length-1; j++) {
                    if (tableData[i][j]== null) {
                        appendHtml += '<td>' + '' + '</td>';
                    } else {
                        if(j==0||i==0||j>1) {
                            if(tableData[i][j]=='本政策') {
                                appendHtml += '<td align="center" valign="middle"><b style="color:red">' + tableData[i][j] + '</b></td>';
                            }
                            else{
                                appendHtml += '<td align="center" valign="middle">' + tableData[i][j] + '</td>';
                            }
                        }
                        else {
                            //appendHtml += '<td align="center" valign="middle"><button  id="submit" value="'+tableData[i][j]+'">'+tableData[i][j]+'</td>';
                            appendHtml += '<td align="center" valign="middle"><a href="javascript:void(0);" onclick="policydetail(this)" policyid="'+tableData[i][j+2]+'">'+tableData[i][j]+'</a></td>';
                        }
                    }
                }
                appendHtml += '</tr>';
            }
            $_corporateTechnologyActivitiesTable.append(appendHtml);
        }

        function shu(json) {
            tree.render({
                elem: '#test13'
                , data: json.data
                , showCheckbox: false  //是否显示复选框
                , id: 'demoId1'
                , isJump: true //是否允许点击节点时弹出新窗口跳转
                , click: function (obj) {
                    var data = obj.data;  //获取当前点击的节点数据
                    //$submit.text(data.title);
                    $policyid.text(data.id);
                    var str="abcdefghijklmno";
                    if(str.indexOf(data.id)!=-1) {
                        febs.get(ctx + 'jsondata/getTableData/' + data.id, null, function (json) {
                        });
                    }
                    else {
                        //$("#container").empty();
                        febs.get(ctx + 'jsondata/getSimilarityData/' + data.id, null, function (json) {
                            initCorporateTechnologyActivities1(json);
                        });
                        febs.get(ctx + 'jsondata/getSRelationData/' + data.id, null, function (json) {
                            tu(json.data);
                        });
                    }
                }
            });
        }

        //按钮事件
        util.event('lay-demo', {
            getChecked: function(othis){
                var id=$policyid.text();
                //var name=$submit.text();//获取选中节点的数据
                var str="abcdefghijklmno";
                if(str.indexOf(id)==-1) {
                    febs.modal.view('政策信息', 'policy/detail/' + id, {
                        area: $(window).width() <= 850 ? '95%' : '80%'
                    });
                }
                else {
                    febs.alert.warn('请选择一个具体政策！');
                }

            }

        });



        function zhuzhuang1(json) {
            var basicColumnChartOptions = {
                chart: {
                    height: 320,
                    type: 'bar',
                    toolbar: {
                        show: false
                    }
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: '65%'
                    }
                },
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    show: true,
                    width: 10,
                    colors: ['transparent']
                },
                series: json.data.data,
                xaxis: {
                    categories: json.data.type
                    // categories: ["1995","1997","1998","2000","2001","2002","2003","2004","2005","2006","2007","2008","2009","2010","2011","2012","2013","2014","2015","2016","2017","2018","2019"]
                },
                fill: {
                    opacity: 1

                },
                tooltip: {
                    y: {
                        formatter: function (val) {
                            return val + " 条"
                        }
                    }
                },
                grid: {
                    row: {
                        colors: ['transparent', 'transparent'],
                        opacity: 0.2
                    },
                    borderColor: '#f1f3fa'
                }
            };

            new ApexCharts(
                document.querySelector("#basicColumnChart"),
                basicColumnChartOptions
            ).render();
        }
        $view.on('click', '#submit', function () {
            $view.find('#submit-form').trigger('click');
        });

        function initTable() {
            tableIns = febs.table.init({
                elem: $view.find('#policyTablelist'),
                id: 'policyTable',
                url: ctx + 'policy/list',
                page: false,
                cols: [[
                    {field: 'name', title: '政策名称', minWidth: 400,hide:true},
                    {field: 'pubdata', title: '发布日期',hide:true},
                    {title: '解析', toolbar: '#user-option', minWidth: 100,align:"center",hide:true}
                    //{title: '相似政策', toolbar: '#user-option1', minWidth: 140}
                ]]
            });
        }
        function initTableData(data) {
            tableIns = febs.table.init({
                elem: $view.find('#policyTablelist'),
                id: 'policyTable',
                url: ctx + 'jsondata/getJsonQuestiontable/'+data,
                cols: [[
                    {field: 'name', title: '政策名称', minWidth: 400},
                    {field: 'pubdata', title: '发布日期'},
                    {title: '解析', toolbar: '#user-option', minWidth: 100,align:"center"}
                    //{title: '相似政策', toolbar: '#user-option1', minWidth: 140}
                ]]
            });
        }

        form.on('submit(dept-form-submit)', function (data) {
            return false;
        });
        table.on('tool(policyTable)', function (obj) {
            var data = obj.data,
                layEvent = obj.event;
            if (layEvent === 'detail') {
                febs.modal.view('政策信息', 'policy/detailnew/' + data.id, {
                    area: $(window).width() <= 850 ? '95%' : '80%'
                });
            }
            if (layEvent === 'detail1') {
                febs.modal.view('政策对比', 'policy/similar/' + data.id, {
                    area: $(window).width() <= 850 ? '95%' : '80%'
                });
            }
            if (layEvent === 'del') {
                febs.modal.confirm('删除政策', '确定删除该政策？', function () {
                    deleteUsers(data.userId);
                });
            }
            if (layEvent === 'edit') {
                febs.modal.open('修改政策', 'system/user/update/' + data.policyName, {
                    area: $(window).width() <= 850 ? '90%' : '80%',
                    btn: ['提交', '取消'],
                    yes: function (index, layero) {
                        $('#user-update').find('#submit').trigger('click');
                    },
                    btn2: function () {
                        layer.closeAll();
                    }
                });
            }
        });
        policydetailneo4j= function (obj)
        {
            var id=$(obj).attr("policyid");
            febs.modal.view('政策信息', 'policy/detailnew/' + id, {
                area: $(window).width() <= 850 ? '95%' : '80%'
            });

        }
        $query.on('click', function () {
            var policyName=$searchForma.find('input[name="policyName"]').val().trim();
            var temp = document.getElementById('question-answer');
            var content = $("#question-answer").text();
            var htmlstr = "";
           // htmlstr += "<p style='font-family:STHeiti;font-size:100%;color:black;'><strong>问："+policyName+"</strong></p>";
            htmlstr += "<p class='box'>问："+policyName+"</p>";
            $("#question-answer").append(htmlstr);
            var linum = temp.getElementsByTagName("p").length
            if(policyName!="") {
                febs.get(ctx + 'jsondata/getJsonQuestion/' + policyName, null, function (json) {
                    $("#question-answer").append("<p class='box1'>答："+json.data.answer+"</p>");
                    if(json.data.flag==1&&json.data.answer!=="无")
                    {
                        $("#content1").empty();
                        $("#policyTable").empty();
                        initTableData(policyName);
                    }
                    if((json.data.flag==3||json.data.flag==2)&&json.data.answer!=="无")
                    {
                        $("#content1").empty();
                        initTable();
                        var htmlstr = "";
                        htmlstr += "<tr>";
                        htmlstr += "<td colspan='2' align='center'><p style='font-family:STHeiti;font-size:100%;color:black;'><strong>" + json.data.name + "</strong></p></td>";
                        htmlstr += "</tr>";
                        htmlstr += "<tr>";
                        htmlstr += "<td ><p style='font-family:STHeiti;font-size:100%;color:black;width: 110px;'><strong>发布部门</strong></p></td>";
                        htmlstr += "<td >" + json.data.dept + "</td>";
                        htmlstr += "</tr>";
                        htmlstr += "<tr>";
                        htmlstr += "<td><p style='font-family:STHeiti;font-size:100%;color:black'><strong>发布时间</strong></p></td>";
                        htmlstr += "<td >" + json.data.year + "</td>";
                        htmlstr += "</tr>";
                        htmlstr += "<tr>";
                        htmlstr += "<td ><p style='font-family:STHeiti;font-size:100%;color:black'><strong>主题词</strong></p></td>";
                        htmlstr += "<td >" + json.data.theme + "</td>";
                        htmlstr += "</tr>";
                        htmlstr += "<tr>";
                        htmlstr += "<td ><p style='font-family:STHeiti;font-size:100%;color:black'><strong>关键词汇</strong></p></td>";
                        htmlstr += "<td >" + json.data.keyword + "</td>";
                        htmlstr += "</tr>";
                        htmlstr += "<tr>";
                        htmlstr += "<td><p style='font-family:STHeiti;font-size:100%;color:black'><strong>实施范围</strong></p></td>";
                        htmlstr += "<td >" + json.data.orange + "</td>";
                        htmlstr += "</tr>";
                        htmlstr += "<tr >";
                        htmlstr += "<td><p style='font-family:STHeiti;font-size:100%;color:black'><strong>政策正文</strong></p></td>";
                        htmlstr += '<td >' + json.data.text + '......';
                        htmlstr += '<a href="javascript:void(0);" onclick="policydetailneo4j(this)" policyid="' + json.data.id + '">点击查看全文</a></td>';
                        htmlstr += "</tr>";
                        $("#content1").append(htmlstr)
                    }
                    if(json.data.flag==4&&json.data.answer!=="无")
                    {
                        $("#content1").empty();
                        initTable();
                        var htmlstr = "";
                        htmlstr += "<tr>";
                        htmlstr += "<td >" + json.data.text + "</td>";
                        htmlstr += "</tr>";
                        htmlstr += "<tr>";
                        htmlstr += "<td >" + json.data.text1 + "</td>";
                        htmlstr += "</tr>";
                        htmlstr += "<tr>";
                        htmlstr += "<td >" + json.data.text2 + "</td>";
                        htmlstr += "</tr>";
                        htmlstr += "<tr>";
                        htmlstr += "<td >" + json.data.text3 + "</td>";
                        htmlstr += "</tr>";
                        $("#content1").append(htmlstr)
                    }
                });
                //initTableData(policyName);
            }
            else {
                febs.alert.warn('请输入内容!');
            }
        });
        $reset.on('click', function () {
        });
    });
</script>