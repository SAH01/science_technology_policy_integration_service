
<div class="layui-fluid layui-anim febs-anim" id="febs-dept" lay-title="">

    <div class="layui-card" >
        <form class="layui-form layui-table-form" lay-filter="user-table-form">
            <span id="hintMessage" class="febs-alert-base febs-alert-warn">提示：输入检索内容进行查找</span>
            <div class="layui-row">
                <div class="layui-col-md10">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label layui-form-label-sm">政策名称</label>
                            <div class="layui-input-inline">
                                <input type="text" name="policyName" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label layui-form-label-sm">发布时间</label>
                            <div class="layui-input-inline">
                                <input type="text" name="createTime" id="createTime" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label layui-form-label-sm">关键词</label>
                            <div class="layui-input-inline">
                                <input type="text" name="keyword" id="keyword" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label layui-form-label-sm">地&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;域</label>
                            <div class="layui-input-inline">
                                <input type="text" name="city" id="city" class="layui-input">
                            </div>
                        </div>

                        <div class="layui-inline">
                            <label class="layui-form-label layui-form-label-sm">全文检索</label>
                            <div class="layui-input-inline">
                                <input type="text" name="policySearch" autocomplete="off" class="layui-input">
                            </div>
                        </div>

                    </div>
                </div>
                <div class="layui-col-md2 layui-col-sm12 layui-col-xs12 table-action-area">
                    <div class="layui-btn layui-btn-sm layui-btn-primary table-action" id="query">
                        <i class="layui-icon">&#xe848;</i>
                    </div>
                    <div class="layui-btn layui-btn-sm layui-btn-primary table-action" id="reset">
                        <i class="layui-icon">&#xe79b;</i>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div class="layui-row layui-col-space8 febs-container">
        <div class="layui-col-md3 layui-col-sm3 layui-col-xs5">
            <div class="layui-card">
                <div class="layui-card-body febs-table-full" style="height:800px;overflow:auto;">
                    <form class="layui-form layui-table-form" lay-filter="dept-table-form" id="dept-table-form">
                        <div class="layui-row">
                            <div class="layui-col-md8 layui-col-sm9 layui-col-xs9">
                                <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
                                    <legend>科技政策分类</legend>
                                </fieldset>
                                <div id="test13" class="demo-tree-more" lay-filter="deptTree"></div>
                                <div class="layui-form-item">
                                    <div class="layui-inline">
                                        <div class="dept-tree" lay-filter="deptTree" style="margin-left: 1rem"></div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </form>

                </div>
            </div>
        </div>
        <div class="layui-col-md6 layui-col-sm6 layui-col-xs12" style="width: 900px">
            <div class="layui-card">
                <table name="policylist" lay-filter="policyTable" lay-data="{id: 'policyTable'}"></table>
                <div class="layui-card-header">政策类别数目</div>
                <div class="layui-card-body">
                    <div id="basicColumnChart"></div>
                </div>

            </div>
        </div>
        <div class="layui-col-md6 layui-col-sm6 layui-col-xs12 febs-hide" style="width:900px">
            <div class="layui-card">


                <div class="layui-card-body febs-table-full">
                    <form class="layui-form layui-table-form" action="" lay-filter="dept-form">
                        <div class="layui-form-item febs-hide">
                            <label class="layui-form-label">ID：</label>
                            <div class="layui-input-block">
                                <input type="text" id="name" name="name" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item febs-hide">
                            <label class="layui-form-label">branchID：</label>
                            <div class="layui-input-block">
                                <input type="text" id="rank" name="rank" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item febs-hide">
                            <label class="layui-form-label">上级ID：</label>
                            <div class="layui-input-block">
                                <input type="text" value="" id="policyid" name="Id" readonly autocomplete="off"
                                       class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item febs-hide">
                            <label class="layui-form-label"></label>
                            <div class="layui-input-block">
                                <input type="text" name="policyId" autocomplete="off" class="layui-input"
                                       lay-verify="number">
                            </div>
                        </div>
                        <button class="layui-btn febs-hide" lay-submit="" lay-filter="dept-form-submit"
                                id="submit-form"></button>


                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/html" id="user-option">
    <span shiro:lacksPermission="user:view,user:update,user:delete">
        <span class="layui-badge-dot febs-bg-orange"></span> 无权限
    </span>
    <a lay-event="detail" shiro:hasPermission="user:view"><i
            class="layui-icon febs-edit-area febs-green">&#xe7a5;</i></a>
</script>
<script type="text/html" id="user-option1">
    <a lay-event="detail1" shiro:hasPermission="user:view"><i
            class="layui-icon febs-edit-area febs-green">&#xe7a5;</i></a>
</script>
<script data-th-inline="javascript" type="text/javascript">
    layui.use([ 'dropdown', 'jquery','tree', 'validate', 'layer','febs', 'form', 'eleTree','element','table','apexcharts', 'jquery', 'util', 'echarts4', 'dataTool', 'echarts_gl'], function () {
        var $ = layui.jquery,
            febs = layui.febs,
            element = layui.element,
            tree = layui.tree,
            layer=layui.layer,
            form = layui.form,
            table=layui.table,
            $viewa = $('#febs-index'),
            echarts = layui.echarts4,
            eleTree = layui.eleTree,
            util = layui.util,
            dropdown = layui.dropdown,
            validate = layui.validate,
            $view = $('#febs-dept'),
            $query = $view.find('#query'),
            sortObject = {field: 'createTime', type: null},
            $reset = $view.find('#reset'),
            $policyid=$view.find('#policyid'),
            $header = $view.find('#form-header'),
            $name=$view.find('#name'),
            $rank=$view.find('#rank'),
            $searchForm = $view.find('#dept-table-form'),
            $searchForma = $view.find('form'),
            _currentDeptData,
            _deptTree;

        form.verify(validate);
        form.render();
        initTableData();
        function Tree_init()
        {
            layer.load(1);
            febs.get(ctx + 'jsondata/getTreeData' , null, function (json) {;
                shu(json);
                layer.closeAll('loading');
            });
        }
        function shu(json) {
            tree.render({
                elem: '#test13'
                , data: json.data.shu
                , showCheckbox: false  //是否显示复选框
                , id: 'demoId1'
                , isJump: true //是否允许点击节点时弹出新窗口跳转
                , click: function (obj) {
                    var data = obj.data;  //获取当前点击的节点数据
                    $policyid.text(data.id);
                    if(data.id==1) {
                        $name.text(data.title);
                    }
                    else if(data.id==0)
                    {
                        $rank.text(data.title);
                    }
                    var t1=$name.text().split(" ")[0];
                    var t2=$rank.text().split(" ")[0];
                    var t22=t2.split("/")[0];
                    var policySearch=$searchForma.find('input[name="policySearch"]').val().trim();
                    var data=policySearch+","+t1+","+t22;
                    initTable(data);
                }
            });
        }
        function initTableData() {
            tableIns = febs.table.init({
                elem: document.getElementsByName('policylist'),
                id: 'policyTable',
                url: ctx + 'policy/list',
                cols: [[
                    {field: 'name', title: '政策文件名', minWidth: 500,align:'center'},
                    {field: 'pubdata', title: '发布日期' ,align:'center'},
                    // {field: 'organ', title: '发布机构'},
                    // {field: 'policy_number', title: '文号'},
                    // {field: 'policy_index', title: '编号'},
                    {title: '解析', toolbar: '#user-option', minWidth: 140,align:'center'}
                    //{title: '相似政策', toolbar: '#user-option1', minWidth: 140}
                ]]
            });
        }

        function initTable(data) {
            tableIns = febs.table.init({
                elem: document.getElementsByName('policylist'),
                id: 'policyTable',
                url: ctx + 'policy/list3/'+data,
                cols: [[
                    {field: 'name', title: '政策文件名', minWidth: 500,align:'center'},
                     {field: 'pubdata', title: '发布日期' ,align:'center'},
                    // {field: 'organ', title: '发布机构'},
                    // {field: 'policy_number', title: '文号'},
                    // {field: 'policy_index', title: '编号'},
                    {title: '解析', toolbar: '#user-option', minWidth: 140,align:'center'}
                    //{title: '相似政策', toolbar: '#user-option1', minWidth: 140}
                ]]
            });
        }
        table.on('tool(policyTable)', function (obj) {
            var policySearch=$searchForma.find('input[name="policySearch"]').val().trim();

            var data = obj.data,
                layEvent = obj.event;
            var id=data.id;
            var result=id+","+policySearch;
            if (layEvent === 'detail') {
                febs.modal.view('政策信息', 'policy/detailnew2/' + result, {
                    area: $(window).width() <= 850 ? '95%' : '80%'
                });
            }
        });
        table.on('sort(policyTable)', function (obj) {
            sortObject = obj;
            tableIns.reload({
                initSort: obj,
                where: $.extend(getQueryParams(), {
                    field: obj.field,
                    order: obj.type
                })
            });
        });



        function zhuzhuang1(json) {
            var basicColumnChartOptions = {
                chart: {
                    height: 320,
                    type: 'bar',
                    toolbar: {
                        show: false
                    }
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: '65%'
                    }
                },
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    show: true,
                    width: 10,
                    colors: ['transparent']
                },
                series: json.data.data,
                xaxis: {
                    categories: json.data.type
                    // categories: ["1995","1997","1998","2000","2001","2002","2003","2004","2005","2006","2007","2008","2009","2010","2011","2012","2013","2014","2015","2016","2017","2018","2019"]
                },
                fill: {
                    opacity: 1

                },
                tooltip: {
                    y: {
                        formatter: function (val) {
                            return val + " 条"
                        }
                    }
                },
                grid: {
                    row: {
                        colors: ['transparent', 'transparent'],
                        opacity: 0.2
                    },
                    borderColor: '#f1f3fa'
                }
            };

            new ApexCharts(
                document.querySelector("#basicColumnChart"),
                basicColumnChartOptions
            ).render();
        }
        function getQueryParams() {
            var createTimeFrom,
                createTimeTo,
                createTime = $searchForm.find('input[name="createTime"]').val();
            if (createTime) {
                createTimeFrom = createTime.split(' - ')[0];
                createTimeTo = createTime.split(' - ')[1];
            }
            return {
                createTimeFrom: createTimeFrom,
                createTimeTo: createTimeTo,
                form: $searchForm.find("select[name='form']").val(),
                name: $searchForm.find('input[name="policyName"]').val().trim(),
                keyword:$searchForm.find('input[name="keyword"]').val().trim(),
                policyorgan:$searchForm.find('input[name="city"]').val().trim(),
                invalidate_ie_cache: new Date()
            };
        }

        $query.on('click', function () {
            var params = $.extend(getQueryParams(), {field: sortObject.field, order: sortObject.type});
            tableIns.reload({where: params, page: {curr: 1}});
            var policySearch=$searchForma.find('input[name="policySearch"]').val().trim();
            var policyName=$searchForma.find('input[name="policyName"]').val().trim();
            if(policySearch!="") {
                $("#basicColumnChart").empty();
                layer.load(1);
                var data = policySearch;
                initTable(data);
                febs.get(ctx + 'performance/getSearch/' + policySearch, null, function (json) {
                    layer.closeAll('loading');
                    zhuzhuang1(json);
                    shu(json);
                });
            }
            else {
                febs.alert.warn('请输入内容!');
            }
        });





    });
</script>